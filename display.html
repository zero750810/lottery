<!-- display.html 只包含主要內容 -->
<style>
  /* 重置基本樣式 */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;  /* 防止滾動 */
  }

  :root {
    --text-color: white;
  }

  #prizeInfo, .draw-item {
    color: var(--text-color) !important;
  }

  /* 背景覆蓋層 */
  .background-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* 主視覺圖片 */
  #mainVisual {
    position: fixed;  /* 改為 fixed */
    top: 0;
    left: 0;
    width: 100vw;  /* 使用 vw 單位 */
    height: 100vh;
    object-fit: cover;
    display: none;
    z-index: 2;
  }

  /* 抽獎區域 */
  #drawSection {
    position: fixed;  /* 改為 fixed */
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 3;
    display: none;
    background-color: rgba(0, 0, 0, 0.5);  /* 半透明背景 */
  }

  #drawArea {
    width: 100%;
    height: 85vh;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  #drawListContainer {
    width: 100%;
    height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
  }

  .draw-item {
    background: transparent !important;
    box-shadow: none !important;
    overflow: hidden;
    text-align: center;
    color: var(--text-color) !important;
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  #prizeInfo {
    width: 100%;
    height: 15vh;
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.3);  /* 半透明背景 */
  }

  #winnerSection {
    position: fixed;  /* 改為 fixed */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: var(--text-color);
    display: none;
    z-index: 4;
  }
</style>

<div class="background-overlay"></div>
<img id="mainVisual" alt="主視覺圖片">

<div id="drawSection">
  <div id="drawArea">
    <div id="drawListContainer">
      <!-- 抽獎動畫和得獎者會在這裡顯示 -->
    </div>
  </div>

  <div id="prizeInfo">
    <!-- 獎品資訊會在這裡顯示 -->
  </div>
</div>

<div id="winnerSection">
  <div id="winnerDisplay"></div>
</div>

<script>
  // 移除全局 channel 宣告，改用 window.channel
  let animationIntervals = [];
  let winners = [];

  function initializeChannel() {
    try {
      const activityId = localStorage.getItem('activityId');
      if (!activityId) {
        console.error('No activityId found in localStorage');
        return;
      }

      if (!window.channel) {
        window.channel = new BroadcastChannel(activityId);
        console.log('Channel initialized with activityId:', activityId);
      }
      
      window.channel.onmessage = (event) => {
        console.log('Received message in display:', event.data);
        handleMessage(event.data);
      };
    } catch (error) {
      console.error('Error initializing channel:', error);
    }
  }

  // 修改初始化函數
  function initialize() {
    // 監聽來自父窗口的消息
    window.addEventListener('message', function(event) {
      // 驗證消息來源
      if (event.origin === window.location.origin) {
        const { type, key, value } = event.data;
        if (type === 'dataUpdated') {
          // 更新本地數據
          localStorage.setItem(key, value);
          // 如果需要，更新顯示
          updateDisplay(key, value);
        }
      }
    });

    // 初始化 channel
    initializeChannel();
    
    // 載入圖片
    loadImages();
  }

  async function loadImages() {
    try {
      // 嘗試從快取中載入背景圖片
      const backgroundCache = await caches.open('lottery-images');
      const backgroundResponse = await backgroundCache.match('background');
      if (backgroundResponse) {
        const backgroundBlob = await backgroundResponse.blob();
        const backgroundUrl = URL.createObjectURL(backgroundBlob);
        document.querySelector('.background-overlay').style.backgroundImage = `url(${backgroundUrl})`;
      }

      // 嘗試從快取中載入主視覺圖片
      const mainVisualResponse = await backgroundCache.match('mainVisual');
      if (mainVisualResponse) {
        const mainVisualBlob = await mainVisualResponse.blob();
        const mainVisualUrl = URL.createObjectURL(mainVisualBlob);
        document.getElementById('mainVisual').src = mainVisualUrl;
      }
    } catch (error) {
      console.error('載入圖片時發生錯誤:', error);
    }
  }

  // 等待 DOM 加載完成後初始化
  document.addEventListener('DOMContentLoaded', initialize);

  function handleMessage(data) {
    console.log('接收到訊息');
    switch (data.type) {
      case 'test':
        console.log('Test message received:', data.message);
        break;
      case 'showMainVisual':
        document.getElementById('mainVisual').style.display = 'block';
        document.getElementById('drawSection').style.display = 'none';
        break;
      case 'showPrizeInfo':
        document.getElementById('mainVisual').style.display = 'none';
        document.getElementById('drawSection').style.display = 'block';
        const currentPrizeInfo = JSON.parse(localStorage.getItem('currentPrizeInfo'));
        if (currentPrizeInfo) {
          document.getElementById('prizeInfo').innerHTML = `
            <h2>${currentPrizeInfo.prizeName} ${currentPrizeInfo.prizeItemName} 共 ${currentPrizeInfo.remainingCount} 份</h2>
          `;
        }
        break;
      case 'showWinners':
        winners = data.winners;
        document.getElementById('startRaffleBtn').style.display = 'none';
        document.getElementById('drawListContainer').style.display = 'flex';
        createDrawItems(winners.length);
        startDrawAnimation();
        break;
    }
  }

  function calculateItemSize(count) {
    let width, height, fontSize;
    if (count <= 1) {
      width = 60; height = 50; fontSize = 6;
    } else if (count <= 2) {
      width = 35; height = 40; fontSize = 5;
    } else if (count <= 9) {
      width = 18; height = 23; fontSize = 2.5;
    } else {
      width = 18; height = 20; fontSize = 2;
    }
    return { width, height, fontSize };
  }

  function createDrawItems(count) {
    const container = document.getElementById('drawListContainer');
    container.innerHTML = '';
    const { width, height, fontSize } = calculateItemSize(count);

    const gridContainer = document.createElement('div');
    gridContainer.style.cssText = `
      display: grid;
      grid-template-columns: repeat(${Math.ceil(Math.sqrt(count))}, 1fr);
      gap: 20px;
      padding: 20px;
      width: 90%;
      max-width: 1200px;
    `;

    for (let i = 0; i < count; i++) {
      const item = document.createElement('div');
      item.className = 'draw-item';
      item.style.cssText = `
        width: ${width}rem;
        height: ${height}rem;
        font-size: ${fontSize}rem;
        transition: transform 0.3s ease;
      `;
      gridContainer.appendChild(item);
    }

    container.appendChild(gridContainer);
  }

  function startDrawAnimation() {
    const drawList = JSON.parse(localStorage.getItem('drawList') || '[]');
    const items = document.querySelectorAll('.draw-item');
    
    items.forEach((item, index) => {
      animationIntervals[index] = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * drawList.length);
        item.innerHTML = `
          <div>${drawList[randomIndex][0]}</div>
          <div>${drawList[randomIndex][1]}</div>
          <div>${drawList[randomIndex][2]}</div>
        `;
      }, Math.random() * 50 + 50);
    });

    // 5秒後停止動畫並顯示獲獎者
    setTimeout(() => {
      stopDrawAnimation();
      displayWinners();
    }, 5000);
  }

  function stopDrawAnimation() {
    animationIntervals.forEach(clearInterval);
  }

  function displayWinners() {
    const items = document.querySelectorAll('.draw-item');
    items.forEach((item, index) => {
      if (index < winners.length) {
        item.innerHTML = `
          <div>${winners[index][0]}</div>
          <div>${winners[index][1]}</div>
          <div>${winners[index][2]}</div>
        `;
        item.style.transform = 'scale(1.1)';
      } else {
        item.innerHTML = '';
      }
    });
  }
</script>