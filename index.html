<!DOCTYPE html>
<html>
<head>
  <title>抽獎系統</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    #gasFrame {
      width: 100%;
      height: 100vh;
      border: none;
      display: none;
    }
    .error-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      padding: 20px;
    }
    .error-message {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 600px;
    }
  </style>
</head>
<body>
  <iframe id="gasFrame"></iframe>
  <div id="errorContainer" class="error-container">
    <div class="error-message">
      <h1>抽獎系統</h1>
      <p>請在網址後方加入您的 GAS ID：</p>
      <code>?gas_id=YOUR_GAS_ID</code>
    </div>
  </div>
  
  <script>
    // 處理導航的函數
    function handleNavigation(params) {
      const { gas_id, page } = params;
      const baseUrl = window.location.origin + window.location.pathname;
      
      if (page === 'display') {
        // 開啟展示頁面
        const displayUrl = `${baseUrl}?gas_id=${gas_id}&page=display`;
        const displayWindow = window.open(displayUrl, 'displayWindow', 'width=800,height=600');
        if (displayWindow) {
          localStorage.setItem('displayWindow', 'true');
        } else {
          alert('請允許開啟彈出視窗以顯示展示頁面');
        }
      } else {
        // 處理其他頁面導航
        window.location.href = `${baseUrl}?gas_id=${gas_id}`;
      }
    }

    // 處理 URL 參數的函數
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        gas_id: params.get('gas_id'),
        page: params.get('page') || ''
      };
    }

    // 更新 iframe 的 src
    function updateIframeSrc() {
      const { gas_id, page } = getUrlParams();
      const errorContainer = document.getElementById('errorContainer');
      const gasFrame = document.getElementById('gasFrame');
      
      if (!gas_id) {
        errorContainer.style.display = 'flex';
        gasFrame.style.display = 'none';
        return;
      }

      errorContainer.style.display = 'none';
      gasFrame.style.display = 'block';
      
      // 構建完整的 GAS URL
      const baseUrl = `https://script.google.com/macros/s/${gas_id}/exec`;
      const url = page ? `${baseUrl}?page=${page}` : baseUrl;
      gasFrame.src = url;
    }

    // 監聽來自 iframe 的消息
    window.addEventListener('message', function(event) {
      // 驗證消息來源
      const allowedOrigins = [
        'https://script.google.com',
        'https://script.googleusercontent.com'
      ];
      
      if (!allowedOrigins.some(origin => event.origin.startsWith(origin))) {
        console.warn('收到未授權來源的消息:', event.origin);
        return;
      }

      const { type, data } = event.data;
      
      switch(type) {
        case 'navigation':
          handleNavigation(data);
          break;
          
        case 'saveData':
          // 儲存數據到 localStorage
          const { key, value } = data;
          localStorage.setItem(key, value);
          console.log('Saved data:', key, value);
          
          // 如果展示窗口已開啟，則轉發消息
          if (localStorage.getItem('displayWindow') === 'true') {
            const displayWindow = window.open('', 'displayWindow');
            if (displayWindow) {
              displayWindow.postMessage({
                type: 'dataUpdated',
                data: { key, value }
              }, window.location.origin);
            }
          }
          break;
          
        case 'openDisplay':
          handleNavigation({ 
            gas_id: getUrlParams().gas_id, 
            page: 'display' 
          });
          break;
      }
    });

    // 監聽 URL 變化
    window.addEventListener('popstate', updateIframeSrc);

    // 初始載入
    updateIframeSrc();

    // 清理函數
    window.addEventListener('beforeunload', function() {
      localStorage.removeItem('displayWindow');
    });
  </script>
</body>
</html>